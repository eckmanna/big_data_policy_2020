---
title: "Big Data for Public Policy - Course Project"
author: "Andreas Eckmann"
date: "August 2020"
output: html_document
---

```{r setup, results='hide', message=FALSE, warning=FALSE}
rm(list=ls())
# Load relevant packages
library(tidyverse)
library(haven)
library(estimatr)
library(readxl)
library(plm)
library(stargazer)
library(Synth)
library(AER)
library(RCurl)
library(openxlsx)
```


```{r}
# Read data from the computer (local)
data = read_excel("C:/Users/Andi Eckmann/Desktop/ETH Studium/MASTERSTUDIUM/2. Semester/Big Data for Public Policy/big_data_policy_2020/course_project/data/cum_and_ann_installed_cap_bundesland.xlsx")
```

```{r}
# Load the csv data from my online repository
urlfile = 'https://raw.githubusercontent.com/eckmanna/big_data_policy_2020/master/course_project/data/cum_and_ann_installed_cap_bundesland.xlsx'
data = read.xlsx(urlfile)
summary(data)
```

```{r q2g_table, echo=TRUE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| Variable             | Description                                 | Unit       |
|----------------------|---------------------------------------------|------------|
| Jahr                 | Year                                        | -          |
| Bundesland           | State                                       | -          |
| Installed_Cap        | Installed PV Capacity                       | kW         |
| Cum_Installed_cap    | Cumulative installed PV Capacity            | kW         |
| module_cost          | Avg. cost per PV module                     | €2016/Wp   |
| feed-in              | National feed-in Tariff                     | ct/kWh     |
| population           | Population of state                         | people     |
| area                 | Area of state                               | km2        |
| log_area             | LOG Area of state                           | -          |
| GDP                  | GDP of state                                | m€         |
| Installed_Cap_pa     | Installed PV Capacity per area              | kW/km2     |
| Cum_Installed_Cap_pa | Cumulative installed PV Capacity per area   | kW/km2     |
| Installed_Cap_pc     | Installed PV Capacity per capita            | kW/cap     |
| Cum_Installed_Cap_pc | Cumulative installed PV Capacity per capita | kW/cap     |
| pop_densityed_Cap_pc | Population density                          | cap/km2    |
| GDP_pc               | GDP per capita (of state)                   | €/cap      |
"
cat(tabl)
```
## 
```{r q1}
#missing data of year 2020 -> filter
data = data %>%
  filter(Jahr < 2020)
attach(data)
```


```{r q1}
#Overwiev
str(data)
dim(data)
data[1:16,1:4]
```

```{r}
summary(Installed_Cap)
boxplot(Installed_Cap)
summary(cum_installed_cap)
boxplot(cum_installed_cap)
```

```{r}
ggplot(data = data) +
  geom_line(mapping = aes(x = Jahr, y = Installed_Cap, linetype = Bundesland, color= Bundesland),
            show.legend = TRUE)
```

```{r}
ggplot(data = data) +
  geom_line(mapping = aes(x = Jahr, y = cum_installed_cap, linetype = Bundesland, color= Bundesland),
            show.legend = TRUE)
```

```{r}
ggplot(data = data) +
  geom_line(mapping = aes(x = Jahr, y = cum_installed_cap_pc, linetype = Bundesland, color= Bundesland),
            show.legend = TRUE)
```
```{r}
ggplot(data = data) +
  geom_line(mapping = aes(x = Jahr, y = cum_installed_cap_pa, linetype = Bundesland, color= Bundesland),
            show.legend = TRUE)
```

```{r}
hist(Installed_Cap_pc)
```


```{r}
model_ols = lm(Installed_Cap_pc ~ `feed-in`)
coeftest(model_ols)
```

```{r}
plot(`feed-in`, Installed_Cap_pc, col="blue", xlab = "feed-in [ct/kWh]", ylab="Installed_cap_pc [kW/cap]")
abline(model_ols, col=3, lwd=3)
```

We face the problem of OVB, missing a lot of information!

```{r}
Installed_Cap_pc_predict_ols = predict(model_ols)

ggplot(data = data) +
  geom_line(mapping = aes(x = `feed-in`, y = Installed_Cap_pc_predict_ols, color = Bundesland),
            show.legend = FALSE)
```

```{r}
model_state = lm(Installed_Cap_pc ~ `feed-in` + Bundesland)
summary(model_state)
```

The resulting Y_i for each entity (state) tells us how much of the effect is caused by factors that are constant over time but vary across entities (states).

These are changes over time which can not be explained by the feed-in.

```{r}
Installed_Cap_pc_predict_state = predict(model_state)

ggplot(data = data) +
  geom_line(mapping = aes(x = `feed-in`, y = Installed_Cap_pc_predict_state, color = Bundesland),
            show.legend = TRUE)
```

```{r}
model_fe = plm(Installed_Cap_pc ~ `feed-in`,
               data = data,
               index = c("Bundesland", "Jahr"),
               model = "within") #within = fixed effects
summary(model_fe)
```

The coefficient of X1 indicates how much Y changes over time, on average per state, when X increases by one unit.

```{r}
coeftest(model_fe, vcov. = vcovHC, type = "HC1")
```

```{r}
rob_se <- list(sqrt(diag(vcovHC(model_ols, type = "HC1"))),
               sqrt(diag(vcovHC(model_state, type = "HC1"))),
               sqrt(diag(vcovHC(model_fe, type = "HC1"))))

stargazer(model_ols, model_state, model_fe,
          digits = 3,
          type = "text",
          keep=c("feed-in"),
          out="myfile",
          out.header=FALSE,
          header = FALSE,
          se = rob_se,
          model.numbers = FALSE,
          column.labels = c("OLS", "with state dummies", "FE model"))
```

```{r}
pFtest(model_fe, model_ols)
#If the p-value is < 0.05 then use fixed effects
```

```{r}
model_year = lm(Installed_Cap_pc ~ `feed-in` + as.factor(Jahr))
summary(model_year)
```


```{r}
# estimate the state and year fixed effects regression with plm()
model_plm = plm(Installed_Cap_pc ~ `feed-in`,
               data = data,
               index = c("Bundesland", "Jahr"),
               model = "within",
               effect = "twoways")
summary(model_plm)
```

```{r}
Installed_Cap_pc_predict_plm = predict(model_plm)

ggplot(data = data) +
  geom_line(mapping = aes(x = `feed-in`, y = Installed_Cap_pc_predict_plm, color = Bundesland),
            show.legend = TRUE)
```

```{r}
model_state_year = lm(Installed_Cap_pc ~ `feed-in` + as.factor(Bundesland) + as.factor(Jahr))
summary(model_state_year)
```

```{r}
model_state_year_2 = plm(Installed_Cap_pc ~ `feed-in`+as.factor(Jahr),
               data = data,
               index = c("Bundesland", "Jahr"),
               model = "within") #within = fixed effects
summary(model_state_year_2)
```


```{r}
Installed_Cap_pc_predict_state_year = predict(model_state_year)

ggplot(data = data) +
  geom_line(mapping = aes(x = `feed-in`, y = Installed_Cap_pc_predict_state_year, color = Bundesland),
            show.legend = TRUE)
```


We accounted for the fixed effects state and time. Looking at changes that are constant over time but vary across states AND are constant across states but vary over time we can control for these effects.

```{r}
vcovCL(model, type = "HC1", cluster = ~ENH_Bundesland)
```
